<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>SmartChat - WebSocket Live</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;margin:0;background:#0b1220;color:#e6edf3}
    header{padding:16px 20px;background:#111827;border-bottom:1px solid #1f2937}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    .panel{background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:16px}
    .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    input[type=text]{flex:1;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e6edf3}
    button{padding:10px 14px;border-radius:10px;border:1px solid #334155;background:#111827;color:#e6edf3;cursor:pointer}
    button:hover{background:#1f2937}
    .log{height:420px;overflow:auto;padding:10px;background:#0b1220;border-radius:10px;border:1px solid #1f2937}
    .msg{margin:8px 0;padding:8px 10px;border-radius:10px;background:#111827;border:1px solid #223047}
    .sys{opacity:.8;font-size:.9rem}
    .me{border-color:#375a7f}
    .time{opacity:.6;font-size:.8rem;margin-left:6px}
  </style>
</head>
<body>
<header>
  <strong>SmartChatEvolution_v1 Â· Level 2 â€” WebSocket (STOMP + SockJS)</strong>
</header>
<div class="wrap">
  <div class="panel">
    <div class="row">
      <input id="nickname" type="text" placeholder="ë‹‰ë„¤ì„(ê¸°ë³¸: guest)" />
      <button id="btnConnect">ì ‘ì†</button>
      <button id="btnDisconnect" disabled>í•´ì œ</button>
    </div>
    <div class="log" id="log"></div>
    <div class="row" style="margin-top:10px;">
      <input id="message" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê³  Enter" disabled />
      <button id="btnSend" disabled>ë³´ë‚´ê¸°</button>
    </div>
  </div>
</div>

<!-- CDN: SockJS & STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
  let stomp = null;
  const $ = (id)=>document.getElementById(id);
  const log = (html)=> { const el=document.createElement('div'); el.innerHTML=html; $('log').appendChild(el); $('log').scrollTop=$('log').scrollHeight; }
  const fmt = (ts)=> new Date(ts).toLocaleTimeString();

  function setConnected(flag){
    $('btnConnect').disabled = flag;
    $('btnDisconnect').disabled = !flag;
    $('message').disabled = !flag;
    $('btnSend').disabled = !flag;
  }

  function connect(){
    const sock = new SockJS('/ws/chat');
    stomp = Stomp.over(sock);
    // ì½˜ì†” ë¡œê·¸ ê³¼ë‹¤ ë°©ì§€: í•„ìš”ì‹œ ë‹¤ìŒ ì¤„ ì£¼ì„ í•´ì œ
    // stomp.debug = null;

    stomp.connect({}, () => {
      setConnected(true);
      const nick = $('nickname').value.trim() || 'guest';
      // êµ¬ë…
      stomp.subscribe('/topic/chat', (frame) => {
        const msg = JSON.parse(frame.body);
        if(msg.type === 'JOIN'){
          log(`<div class="msg sys">ğŸŸ¢ <b>${msg.sender}</b> ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤ <span class="time">${fmt(msg.timestamp)}</span></div>`);
        }else if(msg.type === 'LEAVE'){
          log(`<div class="msg sys">ğŸ”´ <b>${msg.sender}</b> ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤ <span class="time">${fmt(msg.timestamp)}</span></div>`);
        }else{
          const mine = (msg.sender === nick) ? 'me' : '';
          log(`<div class="msg ${mine}"><b>${msg.sender}</b>: ${msg.content} <span class="time">${fmt(msg.timestamp)}</span></div>`);
        }
      });
      // ì…ì¥ ì•Œë¦¼
      stomp.send('/app/chat.join', {}, JSON.stringify({
        type: 'JOIN', sender: nick, content: '', timestamp: Date.now()
      }));
    }, (err) => {
      log(`<div class="msg sys">âŒ ì—°ê²° ì‹¤íŒ¨: ${err}</div>`);
      setConnected(false);
    });
  }

  function disconnect(){
    if(stomp){
      const nick = $('nickname').value.trim() || 'guest';
      try {
        stomp.send('/app/chat.leave', {}, JSON.stringify({
          type: 'LEAVE', sender: nick, content: '', timestamp: Date.now()
        }));
      } catch(e){}
      stomp.disconnect(()=> setConnected(false));
      stomp = null;
    }
  }

  function send(){
    if(!stomp) return;
    const text = $('message').value.trim();
    if(!text) return;
    const nick = $('nickname').value.trim() || 'guest';
    stomp.send('/app/chat.send', {}, JSON.stringify({
      type: 'CHAT', sender: nick, content: text, timestamp: Date.now()
    }));
    $('message').value = '';
  }

  $('btnConnect').onclick = connect;
  $('btnDisconnect').onclick = disconnect;
  $('btnSend').onclick = send;
  $('message').addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
</script>
</body>
</html>
